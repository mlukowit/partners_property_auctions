(function(e){"use strict";if(typeof define==="function"&&define.amd){define(["jquery","jquery.ui.widget"],e)}else{e(window.jQuery)}})(function(e){"use strict";e.support.xhrFileUpload=!!(window.XMLHttpRequestUpload&&window.FileReader);e.support.xhrFormDataFileUpload=!!window.FormData;e.widget("blueimp.fileupload",{options:{namespace:undefined,dropZone:e(document),fileInput:undefined,replaceFileInput:true,paramName:undefined,singleFileUploads:true,limitMultiFileUploads:undefined,sequentialUploads:false,limitConcurrentUploads:undefined,forceIframeTransport:false,redirect:undefined,redirectParamName:undefined,postMessage:undefined,multipart:true,maxChunkSize:undefined,uploadedBytes:undefined,recalculateProgress:true,progressInterval:100,bitrateInterval:500,formData:function(e){return e.serializeArray()},add:function(e,t){t.submit()},processData:false,contentType:false,cache:false},_refreshOptionsList:["namespace","dropZone","fileInput","multipart","forceIframeTransport"],_BitrateTimer:function(){this.timestamp=+(new Date);this.loaded=0;this.bitrate=0;this.getBitrate=function(e,t,n){var r=e-this.timestamp;if(!this.bitrate||!n||r>n){this.bitrate=(t-this.loaded)*(1e3/r)*8;this.loaded=t;this.timestamp=e}return this.bitrate}},_isXHRUpload:function(t){return!t.forceIframeTransport&&(!t.multipart&&e.support.xhrFileUpload||e.support.xhrFormDataFileUpload)},_getFormData:function(t){var n;if(typeof t.formData==="function"){return t.formData(t.form)}if(e.isArray(t.formData)){return t.formData}if(t.formData){n=[];e.each(t.formData,function(e,t){n.push({name:e,value:t})});return n}return[]},_getTotal:function(t){var n=0;e.each(t,function(e,t){n+=t.size||1});return n},_onProgress:function(e,t){if(e.lengthComputable){var n=+(new Date),r,i;if(t._time&&t.progressInterval&&n-t._time<t.progressInterval&&e.loaded!==e.total){return}t._time=n;r=t.total||this._getTotal(t.files);i=parseInt(e.loaded/e.total*(t.chunkSize||r),10)+(t.uploadedBytes||0);this._loaded+=i-(t.loaded||t.uploadedBytes||0);t.lengthComputable=true;t.loaded=i;t.total=r;t.bitrate=t._bitrateTimer.getBitrate(n,i,t.bitrateInterval);this._trigger("progress",e,t);this._trigger("progressall",e,{lengthComputable:true,loaded:this._loaded,total:this._total,bitrate:this._bitrateTimer.getBitrate(n,this._loaded,t.bitrateInterval)})}},_initProgressListener:function(t){var n=this,r=t.xhr?t.xhr():e.ajaxSettings.xhr();if(r.upload){e(r.upload).bind("progress",function(e){var r=e.originalEvent;e.lengthComputable=r.lengthComputable;e.loaded=r.loaded;e.total=r.total;n._onProgress(e,t)});t.xhr=function(){return r}}},_initXHRData:function(t){var n,r=t.files[0],i=t.multipart||!e.support.xhrFileUpload,s=t.paramName[0];if(!i||t.blob){t.headers=e.extend(t.headers,{"X-File-Name":r.name,"X-File-Type":r.type,"X-File-Size":r.size});if(!t.blob){t.contentType=r.type;t.data=r}else if(!i){t.contentType="application/octet-stream";t.data=t.blob}}if(i&&e.support.xhrFormDataFileUpload){if(t.postMessage){n=this._getFormData(t);if(t.blob){n.push({name:s,value:t.blob})}else{e.each(t.files,function(e,r){n.push({name:t.paramName[e]||s,value:r})})}}else{if(t.formData instanceof FormData){n=t.formData}else{n=new FormData;e.each(this._getFormData(t),function(e,t){n.append(t.name,t.value)})}if(t.blob){n.append(s,t.blob,r.name)}else{e.each(t.files,function(e,r){if(r instanceof Blob){n.append(t.paramName[e]||s,r,r.name)}})}}t.data=n}t.blob=null},_initIframeSettings:function(t){t.dataType="iframe "+(t.dataType||"");t.formData=this._getFormData(t);if(t.redirect&&e("<a></a>").prop("href",t.url).prop("host")!==location.host){t.formData.push({name:t.redirectParamName||"redirect",value:t.redirect})}},_initDataSettings:function(e){if(this._isXHRUpload(e)){if(!this._chunkedUpload(e,true)){if(!e.data){this._initXHRData(e)}this._initProgressListener(e)}if(e.postMessage){e.dataType="postmessage "+(e.dataType||"")}}else{this._initIframeSettings(e,"iframe")}},_getParamName:function(t){var n=e(t.fileInput),r=t.paramName;if(!r){r=[];n.each(function(){var t=e(this),n=t.prop("name")||"files[]",i=(t.prop("files")||[1]).length;while(i){r.push(n);i-=1}});if(!r.length){r=[n.prop("name")||"files[]"]}}else if(!e.isArray(r)){r=[r]}return r},_initFormSettings:function(t){if(!t.form||!t.form.length){t.form=e(t.fileInput.prop("form"))}t.paramName=this._getParamName(t);if(!t.url){t.url=t.form.prop("action")||location.href}t.type=(t.type||t.form.prop("method")||"").toUpperCase();if(t.type!=="POST"&&t.type!=="PUT"){t.type="POST"}},_getAJAXSettings:function(t){var n=e.extend({},this.options,t);this._initFormSettings(n);this._initDataSettings(n);return n},_enhancePromise:function(e){e.success=e.done;e.error=e.fail;e.complete=e.always;return e},_getXHRPromise:function(t,n,r){var i=e.Deferred(),s=i.promise();n=n||this.options.context||s;if(t===true){i.resolveWith(n,r)}else if(t===false){i.rejectWith(n,r)}s.abort=i.promise;return this._enhancePromise(s)},_chunkedUpload:function(t,n){var r=this,i=t.files[0],s=i.size,o=t.uploadedBytes=t.uploadedBytes||0,u=t.maxChunkSize||s,a=i.webkitSlice||i.mozSlice||i.slice,f,l,c,h;if(!(this._isXHRUpload(t)&&a&&(o||u<s))||t.data){return false}if(n){return true}if(o>=s){i.error="uploadedBytes";return this._getXHRPromise(false,t.context,[null,"error",i.error])}l=Math.ceil((s-o)/u);f=function(n){if(!n){return r._getXHRPromise(true,t.context)}return f(n-=1).pipe(function(){var s=e.extend({},t);s.blob=a.call(i,o+n*u,o+(n+1)*u);s.chunkIndex=n;s.chunksNumber=l;s.chunkSize=s.blob.size;r._initXHRData(s);r._initProgressListener(s);c=(e.ajax(s)||r._getXHRPromise(false,s.context)).done(function(){if(!s.loaded){r._onProgress(e.Event("progress",{lengthComputable:true,loaded:s.chunkSize,total:s.chunkSize}),s)}t.uploadedBytes=s.uploadedBytes+=s.chunkSize});return c})};h=f(l);h.abort=function(){return c.abort()};return this._enhancePromise(h)},_beforeSend:function(e,t){if(this._active===0){this._trigger("start");this._bitrateTimer=new this._BitrateTimer}this._active+=1;this._loaded+=t.uploadedBytes||0;this._total+=this._getTotal(t.files)},_onDone:function(t,n,r,i){if(!this._isXHRUpload(i)){this._onProgress(e.Event("progress",{lengthComputable:true,loaded:1,total:1}),i)}i.result=t;i.textStatus=n;i.jqXHR=r;this._trigger("done",null,i)},_onFail:function(e,t,n,r){r.jqXHR=e;r.textStatus=t;r.errorThrown=n;this._trigger("fail",null,r);if(r.recalculateProgress){this._loaded-=r.loaded||r.uploadedBytes||0;this._total-=r.total||this._getTotal(r.files)}},_onAlways:function(e,t,n,r){this._active-=1;r.textStatus=t;if(n&&n.always){r.jqXHR=n;r.result=e}else{r.jqXHR=e;r.errorThrown=n}this._trigger("always",null,r);if(this._active===0){this._trigger("stop");this._loaded=this._total=0;this._bitrateTimer=null}},_onSend:function(t,n){var r=this,i,s,o,u=r._getAJAXSettings(n),a=function(n,s){r._sending+=1;u._bitrateTimer=new r._BitrateTimer;i=i||(n!==false&&r._trigger("send",t,u)!==false&&(r._chunkedUpload(u)||e.ajax(u))||r._getXHRPromise(false,u.context,s)).done(function(e,t,n){r._onDone(e,t,n,u)}).fail(function(e,t,n){r._onFail(e,t,n,u)}).always(function(e,t,n){r._sending-=1;r._onAlways(e,t,n,u);if(u.limitConcurrentUploads&&u.limitConcurrentUploads>r._sending){var i=r._slots.shift();while(i){if(!i.isRejected()){i.resolve();break}i=r._slots.shift()}}});return i};this._beforeSend(t,u);if(this.options.sequentialUploads||this.options.limitConcurrentUploads&&this.options.limitConcurrentUploads<=this._sending){if(this.options.limitConcurrentUploads>1){s=e.Deferred();this._slots.push(s);o=s.pipe(a)}else{o=this._sequence=this._sequence.pipe(a,a)}o.abort=function(){var e=[undefined,"abort","abort"];if(!i){if(s){s.rejectWith(e)}return a(false,e)}return i.abort()};return this._enhancePromise(o)}return a()},_onAdd:function(t,n){var r=this,i=true,s=e.extend({},this.options,n),o=s.limitMultiFileUploads,u=this._getParamName(s),a,f,l,c;if(!(s.singleFileUploads||o)||!this._isXHRUpload(s)){l=[n.files];a=[u]}else if(!s.singleFileUploads&&o){l=[];a=[];for(c=0;c<n.files.length;c+=o){l.push(n.files.slice(c,c+o));f=u.slice(c,c+o);if(!f.length){f=u}a.push(f)}}else{a=u}n.originalFiles=n.files;e.each(l||n.files,function(s,o){var u=e.extend({},n);u.files=l?o:[o];u.paramName=a[s];u.submit=function(){u.jqXHR=this.jqXHR=r._trigger("submit",t,this)!==false&&r._onSend(t,this);return this.jqXHR};return i=r._trigger("add",t,u)});return i},_normalizeFile:function(e,t){if(t.name===undefined&&t.size===undefined){t.name=t.fileName;t.size=t.fileSize}},_replaceFileInput:function(t){var n=t.clone(true);e("<form></form>").append(n)[0].reset();t.after(n).detach();e.cleanData(t.unbind("remove"));this.options.fileInput=this.options.fileInput.map(function(e,r){if(r===t[0]){return n[0]}return r});if(t[0]===this.element[0]){this.element=n}},_getFileInputFiles:function(t){t=e(t);var n=e.each(e.makeArray(t.prop("files")),this._normalizeFile),r;if(!n.length){r=t.prop("value");if(!r){return[]}n=[{name:r.replace(/^.*\\/,"")}]}return n},_onChange:function(t){var n=t.data.fileupload,r={fileInput:e(t.target),form:e(t.target.form)};r.files=n._getFileInputFiles(r.fileInput);if(n.options.replaceFileInput){n._replaceFileInput(r.fileInput)}if(n._trigger("change",t,r)===false||n._onAdd(t,r)===false){return false}},_onPaste:function(t){var n=t.data.fileupload,r=t.originalEvent.clipboardData,i=r&&r.items||[],s={files:[]};e.each(i,function(e,t){var n=t.getAsFile&&t.getAsFile();if(n){s.files.push(n)}});if(n._trigger("paste",t,s)===false||n._onAdd(t,s)===false){return false}},_onDrop:function(t){var n=t.data.fileupload,r=t.dataTransfer=t.originalEvent.dataTransfer,i={files:e.each(e.makeArray(r&&r.files),n._normalizeFile)};if(n._trigger("drop",t,i)===false||n._onAdd(t,i)===false){return false}t.preventDefault()},_onDragOver:function(e){var t=e.data.fileupload,n=e.dataTransfer=e.originalEvent.dataTransfer;if(t._trigger("dragover",e)===false){return false}if(n){n.dropEffect="copy"}e.preventDefault()},_initEventHandlers:function(){var e=this.options.namespace;if(this._isXHRUpload(this.options)){this.options.dropZone.bind("dragover."+e,{fileupload:this},this._onDragOver).bind("drop."+e,{fileupload:this},this._onDrop).bind("paste."+e,{fileupload:this},this._onPaste)}this.options.fileInput.bind("change."+e,{fileupload:this},this._onChange)},_destroyEventHandlers:function(){var e=this.options.namespace;this.options.dropZone.unbind("dragover."+e,this._onDragOver).unbind("drop."+e,this._onDrop).unbind("paste."+e,this._onPaste);this.options.fileInput.unbind("change."+e,this._onChange)},_setOption:function(t,n){var r=e.inArray(t,this._refreshOptionsList)!==-1;if(r){this._destroyEventHandlers()}e.Widget.prototype._setOption.call(this,t,n);if(r){this._initSpecialOptions();this._initEventHandlers()}},_initSpecialOptions:function(){var t=this.options;if(t.fileInput===undefined){t.fileInput=this.element.is("input:file")?this.element:this.element.find("input:file")}else if(!(t.fileInput instanceof e)){t.fileInput=e(t.fileInput)}if(!(t.dropZone instanceof e)){t.dropZone=e(t.dropZone)}},_create:function(){var t=this.options;e.extend(t,e(this.element[0].cloneNode(false)).data());t.namespace=t.namespace||this.widgetName;this._initSpecialOptions();this._slots=[];this._sequence=this._getXHRPromise(true);this._sending=this._active=this._loaded=this._total=0;this._initEventHandlers()},destroy:function(){this._destroyEventHandlers();e.Widget.prototype.destroy.call(this)},enable:function(){e.Widget.prototype.enable.call(this);this._initEventHandlers()},disable:function(){this._destroyEventHandlers();e.Widget.prototype.disable.call(this)},add:function(t){if(!t||this.options.disabled){return}if(t.fileInput&&!t.files){t.files=this._getFileInputFiles(t.fileInput)}else{t.files=e.each(e.makeArray(t.files),this._normalizeFile)}this._onAdd(null,t)},send:function(t){if(t&&!this.options.disabled){if(t.fileInput&&!t.files){t.files=this._getFileInputFiles(t.fileInput)}else{t.files=e.each(e.makeArray(t.files),this._normalizeFile)}if(t.files.length){return this._onSend(null,t)}}return this._getXHRPromise(false,t&&t.context)}})})