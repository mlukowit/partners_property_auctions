(function(e){"use strict";if(typeof define==="function"&&define.amd){define(["jquery","tmpl","load-image","./jquery.fileupload-fp"],e)}else{e(window.jQuery,window.tmpl,window.loadImage)}})(function(e,t,n){"use strict";var r=(e.blueimpFP||e.blueimp).fileupload;e.widget("blueimpUI.fileupload",r,{options:{autoUpload:false,maxNumberOfFiles:undefined,maxFileSize:undefined,minFileSize:undefined,acceptFileTypes:/.+$/i,previewSourceFileTypes:/^image\/(gif|jpeg|png)$/,previewSourceMaxFileSize:5e6,previewMaxWidth:80,previewMaxHeight:80,previewAsCanvas:true,uploadTemplateId:"template-upload",downloadTemplateId:"template-download",filesContainer:undefined,prependFiles:false,dataType:"json",add:function(t,n){var r=e(this).data("fileupload"),i=r.options,s=n.files;e(this).fileupload("process",n).done(function(){r._adjustMaxNumberOfFiles(-s.length);n.maxNumberOfFilesAdjusted=true;n.files.valid=n.isValidated=r._validate(s);n.context=r._renderUpload(s).data("data",n);i.filesContainer[i.prependFiles?"prepend":"append"](n.context);r._renderPreviews(s,n.context);r._forceReflow(n.context);r._transition(n.context).done(function(){if(r._trigger("added",t,n)!==false&&(i.autoUpload||n.autoUpload)&&n.autoUpload!==false&&n.isValidated){n.submit()}})})},send:function(t,n){var r=e(this).data("fileupload");if(!n.isValidated){if(!n.maxNumberOfFilesAdjusted){r._adjustMaxNumberOfFiles(-n.files.length);n.maxNumberOfFilesAdjusted=true}if(!r._validate(n.files)){return false}}if(n.context&&n.dataType&&n.dataType.substr(0,6)==="iframe"){n.context.find(".progress").addClass(!e.support.transition&&"progress-animated").attr("aria-valuenow",100).find(".bar").css("width","100%")}return r._trigger("sent",t,n)},done:function(t,n){var r=e(this).data("fileupload"),i;if(n.context){n.context.each(function(s){var o=e.isArray(n.result)&&n.result[s]||{error:"emptyResult"};if(o.error){r._adjustMaxNumberOfFiles(1)}r._transition(e(this)).done(function(){var s=e(this);i=r._renderDownload([o]).replaceAll(s);r._forceReflow(i);r._transition(i).done(function(){n.context=e(this);r._trigger("completed",t,n)})})})}else{if(e.isArray(n.result)){e.each(n.result,function(e,t){if(n.maxNumberOfFilesAdjusted&&t.error){r._adjustMaxNumberOfFiles(1)}else if(!n.maxNumberOfFilesAdjusted&&!t.error){r._adjustMaxNumberOfFiles(-1)}});n.maxNumberOfFilesAdjusted=true}i=r._renderDownload(n.result).appendTo(r.options.filesContainer);r._forceReflow(i);r._transition(i).done(function(){n.context=e(this);r._trigger("completed",t,n)})}},fail:function(t,n){var r=e(this).data("fileupload"),i;if(n.maxNumberOfFilesAdjusted){r._adjustMaxNumberOfFiles(n.files.length)}if(n.context){n.context.each(function(s){if(n.errorThrown!=="abort"){var o=n.files[s];o.error=o.error||n.errorThrown||true;r._transition(e(this)).done(function(){var s=e(this);i=r._renderDownload([o]).replaceAll(s);r._forceReflow(i);r._transition(i).done(function(){n.context=e(this);r._trigger("failed",t,n)})})}else{r._transition(e(this)).done(function(){e(this).remove();r._trigger("failed",t,n)})}})}else if(n.errorThrown!=="abort"){n.context=r._renderUpload(n.files).appendTo(r.options.filesContainer).data("data",n);r._forceReflow(n.context);r._transition(n.context).done(function(){n.context=e(this);r._trigger("failed",t,n)})}else{r._trigger("failed",t,n)}},progress:function(e,t){if(t.context){var n=parseInt(t.loaded/t.total*100,10);t.context.find(".progress").attr("aria-valuenow",n).find(".bar").css("width",n+"%")}},progressall:function(t,n){var r=e(this),i=parseInt(n.loaded/n.total*100,10),s=r.find(".fileupload-progress"),o=s.find(".progress-extended");if(o.length){o.html(r.data("fileupload")._renderExtendedProgress(n))}s.find(".progress").attr("aria-valuenow",i).find(".bar").css("width",i+"%")},start:function(t){var n=e(this).data("fileupload");n._transition(e(this).find(".fileupload-progress")).done(function(){n._trigger("started",t)})},stop:function(t){var n=e(this).data("fileupload");n._transition(e(this).find(".fileupload-progress")).done(function(){e(this).find(".progress").attr("aria-valuenow","0").find(".bar").css("width","0%");e(this).find(".progress-extended").html("&nbsp;");n._trigger("stopped",t)})},destroy:function(t,n){var r=e(this).data("fileupload");if(n.url){e.ajax(n);r._adjustMaxNumberOfFiles(1)}r._transition(n.context).done(function(){e(this).remove();r._trigger("destroyed",t,n)})}},_enableDragToDesktop:function(){var t=e(this),n=t.prop("href"),r=t.prop("download"),i="application/octet-stream";t.bind("dragstart",function(e){try{e.originalEvent.dataTransfer.setData("DownloadURL",[i,r,n].join(":"))}catch(t){}})},_adjustMaxNumberOfFiles:function(e){if(typeof this.options.maxNumberOfFiles==="number"){this.options.maxNumberOfFiles+=e;if(this.options.maxNumberOfFiles<1){this._disableFileInputButton()}else{this._enableFileInputButton()}}},_formatFileSize:function(e){if(typeof e!=="number"){return""}if(e>=1e9){return(e/1e9).toFixed(2)+" GB"}if(e>=1e6){return(e/1e6).toFixed(2)+" MB"}return(e/1e3).toFixed(2)+" KB"},_formatBitrate:function(e){if(typeof e!=="number"){return""}if(e>=1e9){return(e/1e9).toFixed(2)+" Gbit/s"}if(e>=1e6){return(e/1e6).toFixed(2)+" Mbit/s"}if(e>=1e3){return(e/1e3).toFixed(2)+" kbit/s"}return e+" bit/s"},_formatTime:function(e){var t=new Date(e*1e3),n=parseInt(e/86400,10);n=n?n+"d ":"";return n+("0"+t.getUTCHours()).slice(-2)+":"+("0"+t.getUTCMinutes()).slice(-2)+":"+("0"+t.getUTCSeconds()).slice(-2)},_formatPercentage:function(e){return(e*100).toFixed(2)+" %"},_renderExtendedProgress:function(e){return this._formatBitrate(e.bitrate)+" | "+this._formatTime((e.total-e.loaded)*8/e.bitrate)+" | "+this._formatPercentage(e.loaded/e.total)+" | "+this._formatFileSize(e.loaded)+" / "+this._formatFileSize(e.total)},_hasError:function(e){if(e.error){return e.error}if(this.options.maxNumberOfFiles<0){return"maxNumberOfFiles"}if(!(this.options.acceptFileTypes.test(e.type)||this.options.acceptFileTypes.test(e.name))){return"acceptFileTypes"}if(this.options.maxFileSize&&e.size>this.options.maxFileSize){return"maxFileSize"}if(typeof e.size==="number"&&e.size<this.options.minFileSize){return"minFileSize"}return null},_validate:function(t){var n=this,r=!!t.length;e.each(t,function(e,t){t.error=n._hasError(t);if(t.error){r=false}});return r},_renderTemplate:function(t,n){if(!t){return e()}var r=t({files:n,formatFileSize:this._formatFileSize,options:this.options});if(r instanceof e){return r}return e(this.options.templatesContainer).html(r).children()},_renderPreview:function(t,r){var i=this,s=this.options,o=e.Deferred();return(n&&n(t,function(t){r.append(t);i._forceReflow(r);i._transition(r).done(function(){o.resolveWith(r)});if(!e.contains(document.body,r[0])){o.resolveWith(r)}},{maxWidth:s.previewMaxWidth,maxHeight:s.previewMaxHeight,canvas:s.previewAsCanvas})||o.resolveWith(r))&&o},_renderPreviews:function(t,n){var r=this,i=this.options;n.find(".preview span").each(function(n,s){var o=t[n];if(i.previewSourceFileTypes.test(o.type)&&(e.type(i.previewSourceMaxFileSize)!=="number"||o.size<i.previewSourceMaxFileSize)){r._processingQueue=r._processingQueue.pipe(function(){var t=e.Deferred();r._renderPreview(o,e(s)).done(function(){t.resolveWith(r)});return t.promise()})}});return this._processingQueue},_renderUpload:function(e){return this._renderTemplate(this.options.uploadTemplate,e)},_renderDownload:function(e){return this._renderTemplate(this.options.downloadTemplate,e).find("a[download]").each(this._enableDragToDesktop).end()},_startHandler:function(t){t.preventDefault();var n=e(this),r=n.closest(".template-upload"),i=r.data("data");if(i&&i.submit&&!i.jqXHR&&i.submit()){n.prop("disabled",true)}},_cancelHandler:function(t){t.preventDefault();var n=e(this).closest(".template-upload"),r=n.data("data")||{};if(!r.jqXHR){r.errorThrown="abort";t.data.fileupload._trigger("fail",t,r)}else{r.jqXHR.abort()}},_deleteHandler:function(t){t.preventDefault();var n=e(this);t.data.fileupload._trigger("destroy",t,{context:n.closest(".template-download"),url:n.attr("data-url"),type:n.attr("data-type")||"DELETE",dataType:t.data.fileupload.options.dataType})},_forceReflow:function(t){return e.support.transition&&t.length&&t[0].offsetWidth},_transition:function(t){var n=e.Deferred();if(e.support.transition&&t.hasClass("fade")){t.bind(e.support.transition.end,function(r){if(r.target===t[0]){t.unbind(e.support.transition.end);n.resolveWith(t)}}).toggleClass("in")}else{t.toggleClass("in");n.resolveWith(t)}return n},_initButtonBarEventHandlers:function(){var t=this.element.find(".fileupload-buttonbar"),n=this.options.filesContainer,r=this.options.namespace;t.find(".start").bind("click."+r,function(e){e.preventDefault();n.find(".start button").click()});t.find(".cancel").bind("click."+r,function(e){e.preventDefault();n.find(".cancel button").click()});t.find(".delete").bind("click."+r,function(e){e.preventDefault();n.find(".delete input:checked").siblings("button").click();t.find(".toggle").prop("checked",false)});t.find(".toggle").bind("change."+r,function(t){n.find(".delete input").prop("checked",e(this).is(":checked"))})},_destroyButtonBarEventHandlers:function(){this.element.find(".fileupload-buttonbar button").unbind("click."+this.options.namespace);this.element.find(".fileupload-buttonbar .toggle").unbind("change."+this.options.namespace)},_initEventHandlers:function(){r.prototype._initEventHandlers.call(this);var e={fileupload:this};this.options.filesContainer.delegate(".start button","click."+this.options.namespace,e,this._startHandler).delegate(".cancel button","click."+this.options.namespace,e,this._cancelHandler).delegate(".delete button","click."+this.options.namespace,e,this._deleteHandler);this._initButtonBarEventHandlers()},_destroyEventHandlers:function(){var e=this.options;this._destroyButtonBarEventHandlers();e.filesContainer.undelegate(".start button","click."+e.namespace).undelegate(".cancel button","click."+e.namespace).undelegate(".delete button","click."+e.namespace);r.prototype._destroyEventHandlers.call(this)},_enableFileInputButton:function(){this.element.find(".fileinput-button input").prop("disabled",false).parent().removeClass("disabled")},_disableFileInputButton:function(){this.element.find(".fileinput-button input").prop("disabled",true).parent().addClass("disabled")},_initTemplates:function(){var e=this.options;e.templatesContainer=document.createElement(e.filesContainer.prop("nodeName"));if(t){if(e.uploadTemplateId){e.uploadTemplate=t(e.uploadTemplateId)}if(e.downloadTemplateId){e.downloadTemplate=t(e.downloadTemplateId)}}},_initFilesContainer:function(){var t=this.options;if(t.filesContainer===undefined){t.filesContainer=this.element.find(".files")}else if(!(t.filesContainer instanceof e)){t.filesContainer=e(t.filesContainer)}},_stringToRegExp:function(e){var t=e.split("/"),n=t.pop();t.shift();return new RegExp(t.join("/"),n)},_initRegExpOptions:function(){var t=this.options;if(e.type(t.acceptFileTypes)==="string"){t.acceptFileTypes=this._stringToRegExp(t.acceptFileTypes)}if(e.type(t.previewSourceFileTypes)==="string"){t.previewSourceFileTypes=this._stringToRegExp(t.previewSourceFileTypes)}},_initSpecialOptions:function(){r.prototype._initSpecialOptions.call(this);this._initFilesContainer();this._initTemplates();this._initRegExpOptions()},_create:function(){r.prototype._create.call(this);this._refreshOptionsList.push("filesContainer","uploadTemplateId","downloadTemplateId");if(!e.blueimpFP){this._processingQueue=e.Deferred().resolveWith(this).promise();this.process=function(){return this._processingQueue}}},enable:function(){r.prototype.enable.call(this);this.element.find("input, button").prop("disabled",false);this._enableFileInputButton()},disable:function(){this.element.find("input, button").prop("disabled",true);this._disableFileInputButton();r.prototype.disable.call(this)}})})